___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Vibe Pixel",
  "categories": [
    "ATTRIBUTION",
    "REMARKETING"
  ],
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAYAAAB5fY51AAARAklEQVR4Ae3dT3YTx9rH8edpOZjwTvRO7jkh5l6xApwVYAYYzjuI2yvArACyAswKgBVgVoBgcN+YDKysAGcFKJd/99zJqzt4AzhW161qyZaxLVmyuqu7ur+fQTgnhANp1D/Vr6q6SwQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcAYVoALi+E1T9v6rJcnecmLkWiTaNKIt+1Ot9D8wpnXsl/REtWd/7KY/LcluJNHv9t/tysXPu+321Z6gdAisEolvf7Q3nFmWKGlKoi37t/O3U/9DI7+nN5uxN9vCQrf997/sSg3Z67WSmP6aSrRsA2nZ/qumZGfXXv9dTcyv0mh02j9/1xUUjsAqUHrDJXJd1axkcMPtGjWdyES/yqUvnaqOENw1E5PcMUZiyTagJlPtaJI8I7yKRWB55u2Gq9AN5upe8sfFeyrJffEZUuOobKlGz+x17Qi8IrA8KPyGC/QGc+FujHlgR58rUk5dNeZh+5elLYEXBFaO3JyUMYm94TzXl/GCuMEG1808LXFQHUdweUJg5aB0Feakri58s162yfoj121TwrSrUbTOHFd+CKyMxbf+ec+Y/qaUM6i+NqiKD8twg6X1L7GjKjmx/SA4RqLNl6++eyjIHIGVkQBrzIFC68xgVLX4QMXcl2rp2tHWDUZb2SKwMjAYHSTPJYRR1RhG9fHL7cs/iUfxzXfLRqPnVRhVjcNoK1sE1pzi1Y8PTLhzLsd5GxWsr368k0jyWAIO+WkV8WVQVQTWHNZuvbcVUDakWnIPrYqF/LSYkM8AgXUObt7FfLrwqIJhdcCuIhq7iriU+SpiTcPqAPNac4oEMzN/XNipcFg5LbOvO/H/vFuWDNU8rJyWnevcSZ8ZxbkQWDNKa6BIpjdySTXT0Mro5iKsDhFacyCwZuBuuoqPrI5rZnFzEVYnuNB6nr4SBzMhsKaUbgit503XGm7ZOJcaX7ezLJtPi+e+rnXFpPsU0k2hSfJGauw8S/ODfVb6WjAWWx5mQ2CdIV0R/GPxdZU3N05Lo8SucF3pTPPfDkLe7HDdzqbSX2+/+mtbcCYq4RncYyPcdAMmiZ5OO++SvqWC6zYVI42nTMJPh8CawH2IKviM2zxayScX4JPZKrhRs8WJeTXT51BxJgJrgkGlwVFqzP349tuVcT+fVkGNzgw1HGPMSnzrA1+OZyCwxkhHCVSaU02qhlTB83NvV2Wrw2QE1hiMEiY6tRrGN/+1TBWcS3Oayl1nrBKewo2u7HIzcwpnOL5quLb64U0pR1eqXR2eP3jImKYZnFlYuhGNRtFVnjc83YLgpCi6Yz/QgsmG1fAHd6RYGvIlCStV7dgfXoj2d+Xi/sRDUQdnQf65bP/SYzuqvn7KgaveDWq13BWcwAjrmBJtduypStv+Ff0mmoxuOBM1bVLYG0yvmRI803iw8dFOGO+YYt+22lNJnsil/cfznMkY33YrnNGdgv9fGGWNQWAdU/Q7rmxIbdmAejbNBs10dNDfv2+ixlqRIwP3Vs0iD44wmjyJvt3fzPLwWBdcxkQPirquRs2Tl9tLrBoeQ2AdU9Q8TFpjVO+e51t1UGv2bSWr2UKBSlc1uTvt7vvziFffbhZ0XXt6ae9qVU/wPi8C64jhu9m9771SNT+1t5cey5yGB2HslGEeJm92vuxZdOnP+z5uaLfvzJjGU9/X1X6J2c/F5bk/F1XCtoaj+v1Y/OqpMT9kEVaOG53ZD/kNtyomFWYkefjy1dKGr9GHG8EVcV3tHOWa4CsE1hFG5bp4pFGy3v4l29cQVz20BmF1ZVM8K+S6ut3vbCT9CoE1FK+4D4Z6W3VzN15ecy/pzZUk61IxKtouIqwOFHJdPy1uCA4RWAcuXvS3RcBOFud947mRm52grM55ePaayaUvhe9NSq+rnXMUT6iFXyOwDhjjLbDcypZ40H71/ab9IfOTb4qQrgaWZMXMzTkON6fmz34uqYUjBNaBJGmJD/aDnucy/Infzpjgd0y7vWk+r9lUVH1d16Z8XqjDoSdTIbAORNE18cCOFJ6JR5WohhqV7s+fzmeJ8fN3aRoE1hCBNWRM4mnY3eiIZyFXw8HoqqSPqESNTfHCePkyDQGBdSjyEVi9om6+YKuh5xHpLIZbHTqSszI8M1oWBNYhD7uYVQsb5QRZDe3KYOnmrk56IXkz6WtwIASWV3bO499SoNCqoQ3YjpSdqo/TbpocUjFAYPn1f1KwoKqhml+l5AYV38Pu96jB1gYhsHz7bylYWNXQdCUIJv9Ra/KFwBIC66jcNyUaI6VY7QmmGl7cD6K+2lHr75K3vrYEBNaI+thF3SrLruUQqmEw74JSDePPWQEE1pDqsUMK8vJlcUVKoHLPGqIWCKwDJsl/WJ/+NnJPSqJKzxqiHgisAxr5uXHdO45KtERdhWcNUR8E1gGz3xVPhsc4lUKZq2E4e488bDpuhLJimi8C68BevyO+GNlw7wmXkihtNVR/r/yZi0Z/E3hBYA21O25Fyt/rb4eHkJZmb00Zq2HSDyOw/JxhuNAVEFhHqUnyfy5spJV8WqQaTqCqXt+xfx7upCXxgENVBwisoxrGx3Nhh+yo5j7VcIIADmGw85F3JG/KSu4BAuuoz+nOaq+bAKmGkyV/XLgvZWZ0RXLHxtQDBNYRbh5LxfishQ7VcAL7Z8l/BHNO8c13Gz5WCO2XSOkfAveFwDouMlviGdVwotYgGMrHqKcj7BtKJRwisI4ZvjDO+weEajieUX1Qtrms+NY/73nZf+UsfukIUgTWKezqVBGv5aUajleqa+M2tBrT3xQf7IR7MA+Be0BgnebLly3xPPnuUA3HS6/N6j9iKQGTJM/FHb/l4/cS5q+OIrBOkU6+qylkdEE1HM9I42nRj+v8uPrhkXg8FCJSv1ttyo7AGsOd7mu7YVf8oxqO17Sjm52iQite/fjAriL722YRxiEcXhFYE6j2CxldUA0nahURWm5kZSTZFI+COITDMwJrAvftpqKFDMmphhO50Hod3/qQ+2jHBeParQ87XkdWB0p44nXRCKyz7H1xN2oRqzRUw8maxphHa7fe5zav5fZ/uWAULw83H6Pa4fnBk1RwJrc6ZSd8n0sBNEpulGkeY231/Wsp4UnERqLNKJJnWdzk7oFmG4YPCgmqIW3oevt/LzPhfgyBNaV49cNzu8RcxLJ6Vy/t/VCWvTh21LFsVF9LWalsqUYuuDqz/LK0fn9a3DA2k4sMqpSdbH+x/f1VwQkE1pTilTdNc+HCG/G0/+YoGxCPX25f/klKIl59v2lv7NLU1TF6tlbtps/hRe5tnY3uVz+bmKb99Lfs1b1mRFdsSLWkJDQyd9s/L20JTiCwZkA1HClrNQweo6uJmHSfQfvVX9usGg5weEU+bJ29IRiLwJoVq4YpzjXMntr5N1YGJyOwZjR4ZxYbSh3ONcyQO8iXfVdnIrDOgWo4QjXMhnt2ldHV2Qis86IapqiG8zOaPGFVcDqsEs6BVcMRVg3PiVXBmTDCmgPVcIRqeA42rFgVnA2BNS+qYYpqOLOeJmadeavZUAkzQDUcoRpOx640r7sRumAmjLAyQDUcoRqezV0jwup8CKysUA1TVMPJ0rD6hRXB86ISZsht6rQjnh0pANWw9Hr272idVx7PhxFWhtI3lJrkiRSAalhibjXQmFJ9oYSKwMran/ubHF5BNTygqh23dcFdD8HcqIQ5oBqO1Lkauh3sL7ev+H8XfIUxwsoB1XCkltXQVUD7xUFYZY/AygvVMFWzathTSR7qt3s/MF+VDyphjqiGI1Wvhm6uyv7jLjvX88UIK0dUw5GqVsN0Ut19OWxfvkFY5Y/AyhvVMFWxathTO6E+Cirqny9UQg+ohiMhV8O09om8kG+/bJXl2LW6IbA8iW++fWw0uif+ca7h+dmRlLr9U4RUSRBYnqTnGi4uvi7i/DvONZyKXeFz71V376jX3yRJOmz2LB8CyyOq4Ugh1TB9YZ4ZzqO5w1Wdha5c/Nxj9BQGAsszquFAUdWwbMGN2bBK6BurhqmiVg2NaZStimIGjLAKQDUcKaIaMsoKFyOsArChdKSIDaWMssJFYBWFapgqpBoas1Km0Mb0CKyCpEfeK0feO4Ucef9pcUMQHAKrQFTDEd/V0NjpM0FwCKyiUQ1T3qshtTBIBFbBqIYj3qvh/38TC4JCYJUA1XDEZzVMIk71CQ2BVRZUw5TPaqii1wVBIbBKgmp4xN7eY/FxKK2RliAoBFaJUA0H0vAW8XEdmvHtjy1BMAissqEaDgxGWflTwzxWQAiskqEaDgyuQ/qGz3ztJ2xtCAiBVUJUw6Ek+U3yptoSBIPAKiuqocMbP/EVAqukqIaWJrwFFF8hsEqs9tUw+obAwlcIrLKrczXs91sCHEFglVytqyET4jiGwApAXauhEbkmeVOldgaEwApFPavhiuQtkq4gGARWIOpWDePbH1fsD/mP7EyfEVZACKyA1KkamiTxc3bjxX32egWEwApNDaphfPNf7vm+/F+up9LlxOewEFiBKbwarv4j9yAxuv9cPFCR/B/9QaYIrAAVWg2l8TTPV7L8uPrhkf1dWuKFh4erkSkCK1TFVcOmnV/aySO04tWPD1TMffGlsdARBIWj6gNW5JH3Vlej6Eb75++6kgE3svIaVnb+6sX291cFQWGEFbAiq6HVsiOt1/GtD3OFjBuprd36sOM1rCT9pu4IgkNgha64aug0jTGP1lbfv4lvvtuY5Re6LRI/2gpoQ++NOyNQfNPkmSA4VMIKKLgaHtW1nyg76tMXsrDQbf/9L4d7nNI9XJ8vLttwWk5PXS4ipA5QB4NFYFVEfPPtY6ORn82WgVPVn9rbl/28Mx6ZohJWRbHVMCyqbUGQCKyKKHJDaUhUZSurlU34R2BVSMGrhmHQyMup0sgHgVU1VMOxjCQPGV2FjcCqGKrhGHZlMIoWtgRBI7AqiGp4kqphdFUBBFZVUQ0PDSbal7YEwSOwKopqOKRuMysT7VVBYFVYWg3tRLPUmCZmnSpYHQRWxbVfXdk0Ymr53Fy6KvjLEq9ArhACqwaivT/dmxBqdeO6sHppw1pQKTxLWBPuNS7GmB0xvt7mWRyjyZOX21e8vq4GfhBYNVKH0HL19+WrpQ1BJVEJa8RNPqvqDaloPRzUQMKqygismklDa2/vhkq13ljAnFU9UAlrLF59a1cQo6KOoc9KT6Nk3W3hEFQegVVz6dtKTeNpiPNatt527D/uss+qPggspJPxkvTtaEvvSBh66bOB20u8NbRmCCwcim++WzZR9LzMoy33XKB71IZRVT0RWDghvv1uwxg7t1Wi4BrUv/5D5qrqjcDCWC64xER3TIEn3Kh7/7r2nxBUcAgsnOlwjkuj6z5GXeloyvR/lUv7j9vtqz0BhggszMStKoqRWKRxLcORl51EV7eZ9YU70Yb5KYxDYGEugwBrLIv0Wy7E7AisaVSbp4zEejaMemqM/dHttE/+LS6k+rLLGxUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMjMfwAqlZffkZ1fZwAAAABJRU5ErkJggg\u003d\u003d"
  },
  "description": "Vibe Pixel allows you to track conversions and create Custom Audiences on your web site",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "notSetText": "You must set the Pixel Id field.",
    "help": "You can find your Pixel Id on vibe.co.",
    "type": "TEXT",
    "name": "pixelId",
    "displayName": "Pixel Id",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "STRING_LENGTH",
        "args": [
          6,
          6
        ]
      }
    ]
  },
  {
    "type": "RADIO",
    "name": "pixelType",
    "displayName": "",
    "radioItems": [
      {
        "value": "page_view_pixel",
        "displayValue": "Page View pixel",
        "help": "Track a PAGE_VIEW event."
      },
      {
        "value": "event_pixel",
        "displayValue": "Event pixel",
        "help": "Track a conversion event."
      }
    ],
    "simpleValueType": true
  },
  {
    "type": "SELECT",
    "name": "event",
    "displayName": "Event Name",
    "selectItems": [
      {
        "value": "lead",
        "displayValue": "Lead"
      },
      {
        "value": "purchase",
        "displayValue": "Purchase"
      }
    ],
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "pixelType",
        "paramValue": "event_pixel",
        "type": "EQUALS"
      }
    ],
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "alwaysInSummary": false
  },
  {
    "type": "TEXT",
    "name": "price",
    "displayName": "Price USD",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_NEGATIVE_NUMBER"
      }
    ],
    "enablingConditions": [
      {
        "paramName": "event",
        "paramValue": "purchase",
        "type": "EQUALS"
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const sendPixel = require('sendPixel');
const encodeUri = require('encodeUri');
const getReferrerUrl = require('getReferrerUrl');
const getUrl = require('getUrl');
const generateRandom = require('generateRandom');
const setCookie = require('setCookie');
const getCookieValues = require('getCookieValues');
const getTimestampMillis = require('getTimestampMillis');
const encodeUriComponent = require('encodeUriComponent');
const JSON = require('JSON');

// Function to generate random UUIDv4
function uuid() {
  var chars = '0123456789abcdefghijklmnopqrstuvwxyz'.split('');
  var uuid = [];
  var rnd = 0;
  var r;
  for (var i = 0; i < 36; i++) {
    if (i == 8 || i == 13 || i == 18 || i == 23) {
      uuid[i] = '-';
    } else if (i == 14) {
      uuid[i] = '4';
    } else {
      if (rnd <= 2) rnd = 33554432 + ((generateRandom(0, 100000) / 100000) * 16777216) | 0;
      r = rnd & 15;
      rnd = rnd >> 4;
      uuid[i] = chars[(i == 19) ? (r & 3) | 8 : r];
    }
  }
  return uuid.join('');
}

const vibeCookieId = '_vb';
const gaCookieId = '_ga';

// If there is already a vibe cookie no need to create new uuid, but we need to update expire date to 30 days.
var cid = getCookieValues(vibeCookieId)[0];
if (cid === undefined) {
  cid = uuid();
}
setCookie(vibeCookieId, cid, {'max-age': 30 * 24 * 60 * 60, 'secure': true});


var gid = getCookieValues(gaCookieId)[0];
if (gid === undefined) {
  gid = '';
}


var ed = '';
if (data.event == 'purchase' && data.price) {
  ed = JSON.stringify({'price_usd': data.price});
}

var sUrl = 'https://t.vibe.co/pixel/s?' +
  'aid=' + data.pixelId +
  '&gid=' + gid +
  '&cid=' + cid +
  '&eid=' + uuid() +
  '&a=' + (data.pixelType == 'page_view_pixel' ? 'page_view' : data.event) +
  '&ed=' + ed +
  '&v=gtm_1' +
  '&url=' + encodeUri(getUrl()) +
  '&ref=' + encodeUri(getReferrerUrl()) +
  '&ts=' + getTimestampMillis() +
  '&trk=trkid' +
  '&t=img';

sendPixel(sUrl, data.gtmOnSuccess(), data.gtmOnFailure());


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "cookieNames",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "_vb"
              },
              {
                "type": 1,
                "string": "_ga"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_referrer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urlParts",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "queriesAllowed",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_pixel",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://t.vibe.co/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "set_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedCookies",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_vb"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_url",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urlParts",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "queriesAllowed",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: gtmOnSuccess is invoked on sendPixel success
  code: |-
    // test that gtmOnSuccess() is called when sendPixel succeeds
    mock('sendPixel', function(url, onSuccess, onFailure) {
      if (onSuccess != null) {
        onSuccess();
      }
    });

    // Call runCode to run the template's code.
    runCode({});

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: gtmOnFailure is invoked when sendPixel fails
  code: |-
    // test gtmOnFailure() is called when sendPixel fails
    mock('sendPixel', function(url, onSuccess, onFailure) {
      if (onFailure != null) {
        onFailure();
      }
    });

    // Call runCode to run the template's code.
    runCode({});

    // Verify onFailure was called
    assertApi('gtmOnFailure').wasCalled();
- name: Page View sendPixel is invoked with right url
  code: |-
    var triggerUrls = [];

    mock('sendPixel', function(url, onSuccess, onFailure) {
      triggerUrls.push(url);
    });

    // Call runCode to run the template's code.
    runCode({
      pixelId: '1',
      pixelType: 'page_view_pixel'
    });

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();

    // Verify that the URL was correctly fired
    assertApi('sendPixel').wasCalled();
    assertThat(triggerUrls.length).isEqualTo(1);
    assertThat(triggerUrls[0]).isEqualTo('https://t.vibe.co/pixel/s?aid=1&gid=&cid=7a00007a-0000-47a0-8007-a00007a00007&eid=7a00007a-0000-47a0-8007-a00007a00007&a=page_view&ed=&v=gtm_1&url=vibe.co&ref=vibe.co&ts=1&trk=trkid&t=img');
- name: Lead sendPixel is invoked with right url
  code: |-
    var triggerUrls = [];

    mock('sendPixel', function(url, onSuccess, onFailure) {
      triggerUrls.push(url);
    });

    // Call runCode to run the template's code.
    runCode({
      pixelId: '1',
      pixelType: 'event_pixel',
      event: 'lead',
    });

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();

    // Verify that the URL was correctly fired
    assertApi('sendPixel').wasCalled();
    assertThat(triggerUrls.length).isEqualTo(1);
    assertThat(triggerUrls[0]).isEqualTo('https://t.vibe.co/pixel/s?aid=1&gid=&cid=7a00007a-0000-47a0-8007-a00007a00007&eid=7a00007a-0000-47a0-8007-a00007a00007&a=lead&ed=&v=gtm_1&url=vibe.co&ref=vibe.co&ts=1&trk=trkid&t=img');
- name: Purchase sendPixel is invoked with right url
  code: |-
    var triggerUrls = [];

    mock('sendPixel', function(url, onSuccess, onFailure) {
      triggerUrls.push(url);
    });

    // Call runCode to run the template's code.
    runCode({
      pixelId: '1',
      pixelType: 'event_pixel',
      event: 'purchase',
      price: '10'
    });

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();

    // Verify that the URL was correctly fired
    assertApi('sendPixel').wasCalled();
    assertThat(triggerUrls.length).isEqualTo(1);
    assertThat(triggerUrls[0]).isEqualTo('https://t.vibe.co/pixel/s?aid=1&gid=&cid=7a00007a-0000-47a0-8007-a00007a00007&eid=7a00007a-0000-47a0-8007-a00007a00007&a=purchase&ed={"price_usd":"10"}&v=gtm_1&url=vibe.co&ref=vibe.co&ts=1&trk=trkid&t=img');
- name: getCookieValues and setCookie are invoked
  code: |-
    // Call runCode to run the template's code.
    runCode({
      pixelId: '1',
      pixelType: 'page_view_pixel'
    });

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();

    // Verify that the URL was correctly fired
    assertApi('sendPixel').wasCalled();

    // Verify that the URL was correctly fired
    assertApi('setCookie').wasCalled();

    // Verify that the URL was correctly fired
    assertApi('getCookieValues').wasCalled();
- name: setCookie is invoked with new UUID
  code: |-
    var triggerUrls = [];

    mock('sendPixel', function(url, onSuccess, onFailure) {
      triggerUrls.push(url);
    });

    mock('getCookieValues', function(name, decode) {
        return [];
    });

    const cookie_options = {
      'max-age': 30 * 24 * 60 * 60,
      'secure': true
    };

    // Call runCode to run the template's code.
    runCode({
      pixelId: '1',
      pixelType: 'page_view_pixel'
    });

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();

    // Verify that the URL was correctly fired
    assertApi('sendPixel').wasCalled();
    assertThat(triggerUrls.length).isEqualTo(1);
    assertThat(triggerUrls[0]).isEqualTo('https://t.vibe.co/pixel/s?aid=1&gid=&cid=7a00007a-0000-47a0-8007-a00007a00007&eid=7a00007a-0000-47a0-8007-a00007a00007&a=page_view&ed=&v=gtm_1&url=vibe.co&ref=vibe.co&ts=1&trk=trkid&t=img');

    // Verify that the Cookie was correctly set
    assertApi('setCookie').wasCalledWith('_vb', '7a00007a-0000-47a0-8007-a00007a00007', cookie_options);
- name: setCookie is invoked with old UUID
  code: |-
    var triggerUrls = [];

    mock('sendPixel', function(url, onSuccess, onFailure) {
      triggerUrls.push(url);
    });

    mock('getCookieValues', function(name, decode) {
        return ['00000000-0000-0000-0000-000000000000'];
    });

    const cookie_options = {
      'max-age': 30 * 24 * 60 * 60,
      'secure': true
    };

    // Call runCode to run the template's code.
    runCode({
      pixelId: '1',
      pixelType: 'page_view_pixel'
    });

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();

    // Verify that the URL was correctly fired
    assertApi('sendPixel').wasCalled();
    assertThat(triggerUrls.length).isEqualTo(1);
    assertThat(triggerUrls[0]).isEqualTo('https://t.vibe.co/pixel/s?aid=1&gid=00000000-0000-0000-0000-000000000000&cid=00000000-0000-0000-0000-000000000000&eid=7a00007a-0000-47a0-8007-a00007a00007&a=page_view&ed=&v=gtm_1&url=vibe.co&ref=vibe.co&ts=1&trk=trkid&t=img');

    // Verify that the Cookie was correctly set
    assertApi('setCookie').wasCalledWith('_vb', '00000000-0000-0000-0000-000000000000', cookie_options);
setup: |-
  // Need to be mocked to fix the UUID
  mock('generateRandom', 1);

  mock('getTimestampMillis', 1);

  mock('getUrl', 'vibe.co');

  mock('getReferrerUrl', 'vibe.co');


___NOTES___

Created on 25/07/2023 16:20:47


